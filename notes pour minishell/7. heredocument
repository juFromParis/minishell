Voici un guide complet et illustré des usages courants et des variantes du here‑document (heredoc) en shell, avec pour chaque cas la commande, l’effet attendu et des remarques pratiques — puis des conseils d’implémentation pour minishell.

Rappel rapide : la syntaxe de base est
<<DELIM
contenu
DELIM

Le comportement important dépend de la forme du délimiteur (quoté ou non) et de l’opérateur (<< vs <<-).

Heredoc simple (expansions actives)
Exemple :
cat <<EOF
Hello $USER
EOF
Comportement attendu :
Le contenu envoyé à cat contient la valeur de la variable $USER (expansion de paramètres), et les substitutions de commande et arithmétiques sont également évaluées.
Sortie (si USER=alice) :
Hello alice
Remarque : DELIM ici n’est pas cité → expansions actives.
Heredoc avec délimiteur cité (aucune expansion)
Exemple :
cat <<'EOF'
Hello $USER
$(date)
EOF
Comportement attendu :
Aucune expansion : $USER et $(date) restent littéraux.
Sortie :
Hello $USER
$(date)
Remarque : que le délimiteur soit 'EOF' ou "EOF", le comportement d’inhibition des expansions est le même pour here‑doc : les expansions POSIX (paramètre, commande, arithmétique) sont désactivées.
Heredoc avec suppression des tabulations initiales (<<-)
Exemple typique pour indenter proprement dans les scripts :

cat <<-EOF\tLine one\tLine twoEOF
(ici \t = tab)

Comportement attendu :
Les tabulations initiales (caractère tab) de chaque ligne du contenu sont supprimées automatiquement. Permet d’écrire des here‑docs indentés dans un script sans envoyer les tabulations.
Remarque : seule la tabulation (caractère ASCII 0x09) est traitée pour <<- (pas les espaces). Selon implémentation, la ligne fermante peut aussi être indentée par des tabulations.
Heredoc comme entrée standard pour une commande distante (ssh)
Exemple :
ssh user@host 'cat > /tmp/file' <<'EOF'
contenu sans expansion locale
EOF
Comportement attendu :
Le contenu est transmis sur stdin de la commande distante ; selon la façon dont vous quotez DELIM, expansions se feront ou pas localement (le shell local les applique avant transfert).
Remarque pratique : pour éviter d’interpréter du contenu localement, quotez DELIM (souvent on veut que le remote reçoive exactement le texte).
Heredoc pour alimenter une boucle ou un programme dans le même shell
Exemple (traiter ligne par ligne) :
while read line; do echo "got:$line"; done <<EOF
a
b c
EOF
Résultat attendu :
got:a
got:b c
Heredoc utilisé comme script‑inline (interpréteur lit depuis stdin)
Exemple :
python3 - <<'PY'
import sys
print(sys.stdin.read())
PY
Utilité : embarquer un petit script dans un shell script sans créer de fichier temporaire.
Multiple heredocs dans une même commande
Exemple :
cat <<A <<B
textA
A
textB
B
Remarque : on peut avoir plusieurs here-docs ; l’ordre de lecture/association dépend du shell : typiquement les here-docs sont lus avant l’exécution (pour permettre leur stockage/gestion).
Heredoc sur un descripteur de fichier (rediriger FD spécifique)
Exemple :
exec 3<<EOF
data pour fd3
EOF
plus tard : read -u 3 line
Utilité : affecter le contenu à un FD numérique personnalisé.
Heredoc avec substitution de commande à l’intérieur (si non cité)
Exemple :
cat <<EOF
Date is $(date +%Y-%m-%d)
EOF
Résultat : la substitution $(date ...) est évaluée et insérée.
Comportement des délimiteurs et syntaxe à respecter
La ligne qui contient uniquement le délimiteur (suivi d’un newline) termine le here‑document ; il ne doit pas y avoir d’autres caractères sur la ligne (sauf éventuellement des tabulations si <<- et shell les accepte).
Le délimiteur peut être cité ; les quotes font partie de la syntaxe, pas du nom final (elles sont retirées).
Si DELIM est vide ou incorrect, c’est une erreur de syntaxe.
Le shell lit le here‑document avant d’exécuter la commande (important pour l’ordre d’ouverture des FDs et la gestion des heredocs multiples).
Cas pratiques et pièges à connaître
Si DELIM est non cité → expansions s’appliquent (variables, commande, arithmétique).
Si DELIM est cité (quel que soit le type de quote) → aucune expansion n’est effectuée.
<<- enlève uniquement les TAB initiaux ; n’utilisez pas des espaces si vous comptez sur la suppression.
Les here‑docs doivent être lus en gérant correctement les signaux (SIGINT) — l’utilisateur peut interrompre la lecture du heredoc.
Fuite et nettoyage : les shells stockent parfois le contenu en mémoire ou l’écrivent dans un fichier temporaire ; il faut nettoyer ensuite.
Exemples concrets avec sorties attendues
a) Expansion active
Commande :


USER=alicecat <<EOFHello $USER$(echo X)EOF
Sortie :
Hello alice
X

b) Quoted delimiter (pas d'expansion)
Commande :


USER=alicecat <<'EOF'Hello $USER$(echo X)EOF
Sortie :
Hello $USER
$(echo X)

c) Strip tabs (<<-)
Script :


cat <<-EOF    foo    barEOF
Sortie (sans les tabulations) :
foo
bar

d) Heredoc pour un script Python
Commande :


python3 - <<'PY'print("hello from python")PY
Sortie :
hello from python

e) Heredoc + pipeline
Commande :


cat <<EOF | wc -lline1line2EOF
Sortie : 2

Conseils d’implémentation pour minishell
Lecture préalable : lisez tout le contenu des here‑documents (tous les heredocs du pipeline) avant d’exécuter la commande, afin de préparer les FDs/temporaires. C’est le comportement habituel et évite des conflits sur l’ordre d’attente.
Quoting du délimiteur : le lexer/parser doit conserver si le délimiteur était cité ou non (flag) pour décider d’appliquer ou non les expansions dans le contenu lu.
<<- : reconnaître l’option - après << et supprimer les tabs en lecture.
Stockage du contenu : soit en mémoire (string) soit dans un fichier temporaire sécurisé (recommandé si contenu potentiellement volumineux). Si vous utilisez un fichier temporaire, utilisez mkstemp/permissions sûres et supprimez après usage. Assurez‑vous d’ouvrir le fichier en lecture pour la commande.
Gestion des signaux : pendant la lecture des here‑docs, SIGINT doit être traité (arrêter la lecture et nettoyer) — comportement attendu par les tests 42.
Expansion : si le délimiteur est non‑quoté, appliquez les mêmes règles d’expansion que pour un token (paramètres, command substitution, arithmétique) au moment de la lecture. Attention : la substitution de commande éventuelle doit être exécutée (dans un sous‑process) avant d’insérer le texte final.
Substitutions imbriquées : autorisez (si vous implémentez) $(cmd) dans le contenu non‑quoté ; exécutez et capturez sa sortie, puis insérez le résultat (souvent en enlevant la/les dernières nouvelles lignes).
Sécurité : si vous exécutez des substitutions de commande dans le heredoc, gérez correctement les forks et signaux, et ne faites pas d’évaluation non contrôlée sur du contenu non‑fiable.
Tests : ajoutez tests pour chaque variante (quoted, unquoted, <<-, multiple heredocs, heredoc + pipeline, heredoc dans subshell) et vérifiez l’état final (CWD, variables) pour confirmer l’isolation.
Checklist rapide pour vos tests
DELIM non cité → expansions ok.
DELIM cité → aucune expansion.
<<- supprime les tabs initiaux.
Fermeture correcte au delimiter seul sur ligne.
Gestion propre de SIGINT pendant lecture.
Nettoyage des temporaires/FDS.
